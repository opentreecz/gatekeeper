name: Docker Build, Push, and Commit

#
# ---== TRIGGER CONTROLS ==---
#
on:
  # 1. Run on pushes to the 'main' branch
  push:
    branches: [ "main" ]

  # 2. Run on Pull Requests targeting 'main' (but don't push images)
  pull_request:
    branches: [ "main" ]

  # 3. Run weekly (Sunday 00:00) for security rebuilds
  schedule:
    - cron: '0 0 * * 0'

  # 4. Allow manual runs from the "Actions" tab
  workflow_dispatch:

#
# ---== JOB DEFINITIONS ==---
#
jobs:
  build-and-push:
    name: 1. Build and Push Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate unique version tag
        id: version
        run: echo "VERSION=$(TZ='Europe/Prague' date +'%Y.%m.%d')-$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT
        
      - name: Log in to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./gatekeeper
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ghcr.io/opentreecz/gatekeeper:latest
            ghcr.io/opentreecz/gatekeeper:${{ steps.version.outputs.VERSION }}

      - name: Create version file
        if: github.event_name != 'pull_request'
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: echo $VERSION > ${{ runner.temp }}/version.txt
        
      - name: Upload version artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: version-tag
          path: ${{ runner.temp }}/version.txt
          retention-days: 1

  #
  # ---== NEW JOB: UPDATE COMPOSE FILE ==---
  #
  update-docker-compose:
    name: 2. Update docker-compose.yml
    runs-on: ubuntu-latest
    needs: build-and-push # Must run after the build
    
    # Only run for pushes to 'main'
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: write # IMPORTANT: Needs permission to push to the repo
      
    steps:
      # 1. Check out the code
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Use default token for push

      # 2. Download the version tag
      - name: Download version artifact
        uses: actions/download-artifact@v4
        with:
          name: version-tag
          path: ${{ runner.temp }}
          
      # 3. Read the version tag into an environment variable
      - name: Read version tag
        id: version
        run: echo "VERSION=$(cat ${{ runner.temp }}/version.txt)" >> $GITHUB_OUTPUT

      # 4. Use 'sed' to replace the image tag in docker-compose.yml
      - name: Update image tag in docker-compose.yml
        env:
          VERSION_TAG: ${{ steps.version.outputs.VERSION }}
        run: |
          sed -i "s|image: ghcr.io/opentreecz/gatekeeper:.*|image: ghcr.io/opentreecz/gatekeeper:${VERSION_TAG}|g" docker-compose.yml

      # 5. Configure Git for the bot
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions-bot@users.noreply.github.com"

      # 6. Commit and push the change
      - name: Commit and push changes
        run: |
          git add docker-compose.yml
          # Check if there are changes to commit
          if ! git diff-index --quiet HEAD; then
            git commit -m "ci: Update gatekeeper image to ${{ steps.version.outputs.VERSION }} [ci skip]"
            git push
          else
            echo "No changes to commit."
          fi

  #
  # ---== RELEASE JOB ==---
  #
  create-release:
    name: 3. Create GitHub Release
    runs-on: ubuntu-latest
    # This job now waits for BOTH build and the compose file update
    needs: [build-and-push, update-docker-compose] 
    
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write 

    steps:
      - name: Download version artifact
        uses: actions/download-artifact@v4
        with:
          name: version-tag
          path: ${{ runner.temp }}
          
      - name: Read version tag
        id: version
        run: echo "VERSION=$(cat ${{ runner.temp }}/version.txt)" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            Automated multi-platform container release.
            The `docker-compose.yml` file has been automatically updated.
            
            Image pushed to:
            - `ghcr.io/opentreecz/gatekeeper:${{ steps.version.outputs.VERSION }}`
          draft: false
          prerelease: false
